<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>1 gegen 100 – Präsentation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="socket-url" content="https://api.1gegedrsaal.ch">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Die Wand</h1>

    <div class="card">
      <div class="row">
        <span class="badge">Im Spiel: <span id="aliveCount">0</span>/<span id="totalCount">0</span></span>
        <span class="badge">Phase: <span id="phaseText">lobby</span></span>
        <span class="badge">Solo: #<span id="soloNum">–</span></span>
        <span class="badge">Konto: <span id="bank">0</span> (Δ <span id="gain">0</span>)</span>
        <span class="badge">Joker: <span id="jokerInfo">bereit</span></span>
      </div>

      <!-- Themenwahl -->
      <div id="topicPanel" style="margin-top:12px;">
        <h2>Wähle ein Thema</h2>
        <div id="topicsGrid" class="grid topics"></div>
        <div class="footer">Einzelspieler wählt, Admin bestätigt.</div>
      </div>

      <!-- Frage/Timer -->
      <div id="questionPanel" style="display:none;margin-top:12px;">
        <div class="footer">Thema: <b><span id="topicName">–</span></b></div>
        <h2 id="qText">–</h2>
        <div id="ansList" class="answers"></div>
        <div class="footer">Mob-Timer</div>
        <div class="timerBar"><div id="mobFill" class="timerFill"></div></div>
        <div class="footer">Solo-Timer</div>
        <div class="timerBar"><div id="soloFill" class="timerFill" style="background:linear-gradient(90deg,#6dd5fa,#2979ff);"></div></div>
        <div class="footer">Einzelspieler (#<span id="soloDisp">–</span>) – <span id="soloTimerText">25s Lock-In</span>. <span id="soloLocked" class="badge" style="display:none;">Antwort gespeichert</span></div>
      </div>

      <!-- Grid -->
      <div id="gridPanel" style="margin-top:16px;">
        <div id="grid" class="grid auto"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script src="socket-config.js"></script>
  <script>
    const socket = createSocket();

    let cells = new Map(); let known = new Set();
    let revealInProgress = false; let revealingSet = new Set();
    let lastAnswers = [];       // aktuelle Antworten A/B/C
    let mobTimerHandle = null; let soloTimerHandle = null;
    let soloTimerEnds = null;

    function setPhase(p){ document.getElementById('phaseText').innerText=p; }
    function show(id,b=true){ document.getElementById(id).style.display=b?'block':'none'; }

    function ensureCells(players) {
      const grid = document.getElementById('grid');
      const nums = players.map(p => p.number).sort((a,b)=>a-b);
      const incoming = new Set(nums);
      nums.forEach(n => {
        if (!known.has(n)) {
          const d = document.createElement('div');
          d.className = 'cell alive';
          d.textContent = n;
          grid.appendChild(d);
          cells.set(n, d);
          known.add(n);
        }
      });
      // Spieler, die nicht mehr existieren, entfernen
      [...known].forEach(n => {
        if (!incoming.has(n)) {
          const el = cells.get(n);
          if (el?.parentNode) el.parentNode.removeChild(el);
          cells.delete(n);
          known.delete(n);
        }
      });
      if (!revealInProgress) {
        players.forEach(p => {
          const c = cells.get(p.number); if (!c) return;
          c.classList.remove('alive','out','elim');
          c.classList.add(p.alive ? 'alive' : 'out');
        });
      }
    }

    function wait(ms){ return new Promise(r => setTimeout(r, ms)); }
    async function animateEliminationShow(numbers) {
      revealInProgress = true; revealingSet = new Set(numbers);
      for (const num of numbers) {
        const c = cells.get(num); if(!c) continue;
        await wait(50 + Math.random()*250);
        const flicks = 1 + Math.floor(Math.random()*3);
        for (let i=0;i<flicks;i++){
          c.classList.remove('alive','out'); c.classList.add('elim');
          await wait(120 + Math.random()*100);
          c.classList.remove('elim'); c.classList.add('alive');
          await wait(80 + Math.random()*100);
        }
        c.classList.remove('alive','elim'); c.classList.add('out');
        await wait(100 + Math.random()*400);
      }
      revealInProgress = false; revealingSet.clear();
    }

    // Themenwahl
    socket.on('topicOffered', ({options})=>{
      setPhase('topicOffer'); show('topicPanel',true); show('questionPanel',false);
      const grid = document.getElementById('topicsGrid'); grid.innerHTML='';
      options.forEach(t=>{
        const div=document.createElement('div'); div.className='topic'; div.textContent=t;
        div.onclick = ()=>{
          [...grid.children].forEach(ch=>ch.classList.remove('selected'));
          div.classList.add('selected');
          socket.emit('chooseTopic', t);
        };
        grid.appendChild(div);
      });
    });
    socket.on('topicChosen', ({chosenTopic})=>{
      [...document.getElementById('topicsGrid').children].forEach(ch=>{
        if(ch.textContent===chosenTopic) ch.classList.add('selected'); else ch.classList.remove('selected');
      });
    });

    // Frage
    socket.on('displayQuestion', (q)=>{
      document.getElementById('topicName').innerText=q.topic;
      document.getElementById('qText').innerText=q.text;

      const ans = document.getElementById('ansList'); ans.innerHTML='';
      lastAnswers = q.answers.slice();
      document.getElementById('soloLocked').style.display='none';
      document.getElementById('soloFill').style.width='0%';
      document.getElementById('soloTimerText').innerText = 'Lock-In läuft…';

      q.answers.forEach((a,i)=>{
        const b=document.createElement('button');
        b.className='btn choice display';
        b.innerText = `${String.fromCharCode(65+i)}) ${a}`;
        ans.appendChild(b);
      });

      setPhase('question'); show('topicPanel',false); show('questionPanel',true);
      document.getElementById('mobFill').style.width='0%';
    });

    // Mob-Timer Balken
    socket.on('mobTimerStart', ({seconds})=>{
      const fill=document.getElementById('mobFill');
      const start=Date.now(), dur=Math.max(0, seconds)*1000;
      if (mobTimerHandle) clearInterval(mobTimerHandle);
      fill.style.width='0%';
      mobTimerHandle=setInterval(()=>{
        const p=Math.min(1,(Date.now()-start)/dur || 1);
        fill.style.width=(p*100)+'%';
        if(p>=1) { clearInterval(mobTimerHandle); mobTimerHandle=null; }
      }, 50);
    });
    socket.on('questionLocked', ()=>{
      if (mobTimerHandle) clearInterval(mobTimerHandle);
      mobTimerHandle=null;
      document.getElementById('mobFill').style.width='100%';
    });

    socket.on('soloTimerStart', ({seconds})=>{
      const fill=document.getElementById('soloFill');
      const start=Date.now(), dur=Math.max(0, seconds)*1000;
      soloTimerEnds = start + dur;
      if (soloTimerHandle) clearInterval(soloTimerHandle);
      fill.style.width='0%';
      document.getElementById('soloTimerText').innerText = `${seconds}s Lock-In`;
      soloTimerHandle=setInterval(()=>{
        const p=Math.min(1,(Date.now()-start)/dur || 1);
        fill.style.width=(p*100)+'%';
        const remain = Math.max(0, Math.ceil((soloTimerEnds - Date.now())/1000));
        document.getElementById('soloTimerText').innerText = `${remain}s Lock-In`;
        if(p>=1) { clearInterval(soloTimerHandle); soloTimerHandle=null; }
      }, 50);
    });
    socket.on('soloTimerEnd', ()=>{
      if (soloTimerHandle) clearInterval(soloTimerHandle);
      soloTimerHandle=null;
      document.getElementById('soloFill').style.width='100%';
      document.getElementById('soloTimerText').innerText = 'Lock-In beendet';
    });

    // Solo eingeloggt: Button markieren
    socket.on('soloAnswerSet', ({ index, answer })=>{
      const buttons = [...document.getElementById('ansList').querySelectorAll('.choice')];
      buttons.forEach(x=>x.classList.remove('soloLocked'));
      if (buttons[index]) {
        buttons[index].classList.add('soloLocked');
        document.getElementById('soloLocked').style.display='inline-flex';
      }
    });

    socket.on('eliminatedAnswers', ({ indices })=>{
      const buttons = [...document.getElementById('ansList').querySelectorAll('.choice')];
      indices.forEach(i => { if (buttons[i]) buttons[i].classList.add('disabled'); });
    });

    // Show (ohne richtige Antwort zu verraten)
    socket.on('eliminationSequence', async ({ eliminatedNumbers })=>{
      await animateEliminationShow(eliminatedNumbers);
    });

    // Richtige Antwort jetzt grün/rot zeigen
    socket.on('revealCorrect', ({ correct, soloAnswer })=>{
      const buttons = [...document.getElementById('ansList').querySelectorAll('.choice')];
      const idxCorrect = lastAnswers.findIndex(a => a === correct);
      if (idxCorrect>=0 && buttons[idxCorrect]) buttons[idxCorrect].classList.add('correct');
      if (soloAnswer && soloAnswer !== correct) {
        const idxSolo = lastAnswers.findIndex(a => a === soloAnswer);
        if (idxSolo>=0 && buttons[idxSolo]) buttons[idxSolo].classList.add('wrong');
      }
    });

    // Nach Show/Reveal: Statuse
    socket.on('questionEnded', ({correct, soloAnswer})=>{
      // Optionaler Banner – hier handled die Admin-Ansicht das Zurückspringen
    });

    // Allgemein
    socket.on('stats', ({alive,total,gamePhase,soloNumber,prizePool,lastGain,jokers})=>{
      document.getElementById('aliveCount').innerText=alive;
      document.getElementById('totalCount').innerText=total;
      setPhase(gamePhase); document.getElementById('soloNum').innerText = soloNumber ?? '–';
      document.getElementById('soloDisp').innerText = soloNumber ?? '–';
      if (prizePool!=null) {
        document.getElementById('bank').innerText = prizePool;
        document.getElementById('gain').innerText = lastGain;
      }
      if (jokers) {
        const info = [];
        if (jokers.doubleActive) info.push('Doppel aktiv');
        if (jokers.doubleUsed && !jokers.doubleActive) info.push('Doppel verbraucht');
        if (jokers.buyUsed) info.push('Antwort kaufen genutzt');
        document.getElementById('jokerInfo').innerText = info.join(' · ') || 'bereit';
      }
    });
    socket.on('updatePlayers', (players)=>{ ensureCells(players); });
    socket.on('phaseChanged', ({gamePhase})=>{
      setPhase(gamePhase);
      if(gamePhase==='topicOffer'){ show('topicPanel',true); show('questionPanel',false); }
    });
  </script>
</body>
</html>
