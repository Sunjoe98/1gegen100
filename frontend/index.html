<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>1 gegen 100 – Spieler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>1 gegen 100</h1>

    <div id="joinCard" class="card">
      <div class="row">
        <input id="name" class="input" placeholder="Dein Name">
        <button id="joinBtn" class="btn">Beitreten</button>
      </div>
      <div class="footer">
        <span class="badge">Im Spiel: <span id="aliveCount">0</span>/<span id="totalCount">0</span></span>
        <span class="badge">Phase: <span id="phaseText">Lobby</span></span>
        <span class="badge">Konto: <span id="bank">0</span></span>
      </div>
      <div id="spectator" class="card" style="margin-top:12px;">
        <div class="footer">Live:</div>
        <div id="spectatorQuestion">Warten …</div>
      </div>
    </div>

    <div id="gameCard" class="card" style="display:none;margin-top:12px;">
      <div class="footer">
        Deine Nummer: <b><span id="myNumber">?</span></b> ·
        Im Spiel: <span id="aliveCount2">0</span>/<span id="totalCount2">0</span>
      </div>
      <div id="mobTimer" class="timerBar" style="display:none;"><div id="mobFill" class="timerFill"></div></div>
      <h2 id="questionText">Warten auf nächste Frage…</h2>
      <div id="answers" class="answers"></div>
      <div id="hint" class="badge" style="margin-top:8px;"></div>
      <div id="jokerHint" class="footer"></div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script src="socket-config.js"></script>
  <script>
    const socket = createSocket();

    let locked = false;
    let mobTimerSeconds = 0;
    let disabledAnswers = new Set();
    function setPhase(p){ document.getElementById('phaseText').innerText = p; }

    document.getElementById('joinBtn').onclick = () => {
      const name = document.getElementById('name').value || 'Spieler';
      socket.emit('joinGame', name);
      document.getElementById('joinCard').style.display='none';
      document.getElementById('gameCard').style.display='block';
    };

    socket.on('youAre', ({ number }) => { document.getElementById('myNumber').innerText = number; });

    socket.on('stats', ({alive,total,gamePhase,prizePool}) => {
      document.getElementById('aliveCount').innerText = alive; document.getElementById('totalCount').innerText = total;
      document.getElementById('aliveCount2').innerText = alive; document.getElementById('totalCount2').innerText = total;
      setPhase(gamePhase);
      if (prizePool!=null) document.getElementById('bank').innerText = prizePool;
    });

    socket.on('displayQuestion', q => { document.getElementById('spectatorQuestion').innerText = q.text; });
    socket.on('bankUpdate', ({prizePool})=>{
      if (prizePool!=null) document.getElementById('bank').innerText = prizePool;
    });

    socket.on('newQuestion', (q) => {
      locked=false;
      disabledAnswers = new Set();
      document.getElementById('questionText').innerText=q.text;
      const aEl=document.getElementById('answers'); const hint=document.getElementById('hint');
      aEl.innerHTML=''; hint.textContent=''; document.getElementById('jokerHint').textContent='';
      q.answers.forEach(a=>{
        const btn=document.createElement('button'); btn.className='btn choice'; btn.innerText=a;
        btn.dataset.idx = String(q.answers.indexOf(a));
        btn.onclick=()=>{ if(locked || btn.classList.contains('disabled')) return; socket.emit('answer', a);
          [...aEl.querySelectorAll('.choice')].forEach(b=>b.classList.remove('active')); btn.classList.add('active');
          hint.textContent=`Antwort aktuell: ${a} (${mobTimerSeconds||''}s)`;
        };
        aEl.appendChild(btn);
      });
    });

    // Mob-Timer (10s)
    let mobTimerHandle=null;
    socket.on('mobTimerStart', ({seconds})=>{
      mobTimerSeconds = seconds;
      const bar=document.getElementById('mobTimer'); const fill=document.getElementById('mobFill');
      bar.style.display='block'; fill.style.width='0%';
      const start=Date.now(), dur=seconds*1000;
      mobTimerHandle=setInterval(()=>{
        const p=Math.min(1,(Date.now()-start)/dur); fill.style.width=(p*100)+'%';
        if(p>=1){ clearInterval(mobTimerHandle); }
      }, 50);
    });
    socket.on('mobTimerEnd', ()=>{
      if(mobTimerHandle) clearInterval(mobTimerHandle);
      document.getElementById('mobTimer').style.display='none';
      locked=true;
    });

    socket.on('answerAck', ans => { document.getElementById('hint').textContent='Antwort aktuell: '+ans; });
    socket.on('questionLocked', ()=>{ locked=true; });
    socket.on('eliminatedAnswers', ({indices})=>{
      disabledAnswers = new Set(indices);
      document.getElementById('jokerHint').textContent = 'Eine falsche Antwort wurde entfernt.';
      [...document.getElementById('answers').querySelectorAll('.choice')].forEach(btn=>{
        const idx = Number(btn.dataset.idx);
        if (disabledAnswers.has(idx)) btn.classList.add('disabled');
      });
    });
    socket.on('youAreOut', ()=>{
      alert('Du bist ausgeschieden. Zuschaueransicht wird angezeigt.');
      document.getElementById('joinCard').style.display='block';
      document.getElementById('gameCard').style.display='none';
    });
    socket.on('joinRejected', (msg)=>{ alert(msg); document.getElementById('joinCard').style.display='block'; document.getElementById('gameCard').style.display='none'; });
  </script>
</body>
</html>
