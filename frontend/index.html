<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>1 gegen 100 – Spieler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>1 gegen 100</h1>

    <!-- Join- / Zuschauer-Karte -->
    <div id="joinCard" class="card">
      <div class="row">
        <input id="name" class="input grow" placeholder="Dein Name">
        <button id="joinBtn" class="btn">Beitreten</button>
      </div>
      <div class="footer">
        <span id="statusBadge" class="badge">Status: <span id="statusText">Lobby</span></span>
        <span class="badge">Im Spiel: <span id="aliveCount">0</span>/<span id="totalCount">0</span></span>
      </div>
      <div id="spectator" class="card" style="margin-top:12px;">
        <div class="footer">Live-Ansicht (Zuschauer):</div>
        <div id="spectatorQuestion" class="center" style="font-size:18px;">Warten auf Frage…</div>
      </div>
    </div>

    <!-- Spiel-Karte -->
    <div id="gameCard" class="card" style="display:none; margin-top:12px;">
      <div class="footer">
        Deine Nummer: <b><span id="myNumber">?</span></b>
        &nbsp;·&nbsp; Im Spiel: <span id="aliveCount2">0</span>/<span id="totalCount2">0</span>
      </div>
      <h2 id="questionText">Warten auf nächste Frage…</h2>
      <div id="answers" class="answers"></div>
      <hr class="hr">
      <div id="hint" class="badge"></div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script>
    const SOCKET_URL = 'https://onegegen100-u6h7.onrender.com';
    const socket = io(SOCKET_URL);

    const joinCard = document.getElementById('joinCard');
    const gameCard = document.getElementById('gameCard');
    const joinBtn  = document.getElementById('joinBtn');

    let locked = false;

    function setStatus(text, type){
      document.getElementById('statusText').innerText = text;
      const badge = document.getElementById('statusBadge');
      badge.classList.remove('ok','warn');
      if(type==='ok') badge.classList.add('ok');
      if(type==='warn') badge.classList.add('warn');
    }

    // Zuschauer-Infos (immer sichtbar)
    socket.on('displayQuestion', (q) => {
      document.getElementById('spectatorQuestion').innerText = q.text;
    });
    socket.on('stats', ({alive,total,gameActive,registrationOpen}) => {
      document.getElementById('aliveCount').innerText = alive;
      document.getElementById('totalCount').innerText = total;
      document.getElementById('aliveCount2').innerText = alive;
      document.getElementById('totalCount2').innerText = total;

      if(!registrationOpen && gameActive){
        setStatus('Spiel läuft – keine Anmeldung möglich', 'warn');
        joinBtn.disabled = true;
      } else if (registrationOpen && !gameActive) {
        setStatus('Lobby – Anmeldung möglich', 'ok');
        joinBtn.disabled = false;
      } else {
        setStatus('Wartet auf nächste Phase', null);
      }
    });

    // Join
    joinBtn.onclick = () => {
      const name = document.getElementById('name').value || 'Spieler';
      socket.emit('joinGame', name);
      // Anzeige vorziehen – bei Rejection wird zurückgestellt
      joinCard.style.display = 'none';
      gameCard.style.display = 'block';
    };

    socket.on('joinRejected', (msg) => {
      alert(msg);
      joinCard.style.display = 'block';
      gameCard.style.display = 'none';
    });

    // Eigene Nummer
    socket.on('youAre', ({ number }) => {
      document.getElementById('myNumber').innerText = number;
    });

    // Spieler-UI
    socket.on('newQuestion', (q) => {
      locked = false;
      document.getElementById('questionText').innerText = q.text;
      const answersEl = document.getElementById('answers');
      const hint = document.getElementById('hint');
      hint.textContent = '';
      answersEl.innerHTML = '';

      q.answers.forEach(a => {
        const btn = document.createElement('button');
        btn.className = 'btn choice';
        btn.innerText = a;
        btn.onclick = () => {
          if (locked) return;
          socket.emit('answer', a);
          // Visual „aktive“ Auswahl, aber änderbar
          [...answersEl.querySelectorAll('.choice')].forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          hint.textContent = 'Antwort aktuell: ' + a + ' (änderbar bis Stopp)';
        };
        answersEl.appendChild(btn);
      });
    });

    socket.on('answerAck', (ans) => {
      const hint = document.getElementById('hint');
      hint.textContent = 'Antwort aktuell: ' + ans + ' (änderbar bis Stopp)';
    });

    socket.on('questionLocked', () => { locked = true; });

    socket.on('questionEnded', ({correct}) => {
      const hint = document.getElementById('hint');
      hint.textContent = 'Richtig war: ' + correct;
    });

    // NEU: Du bist raus -> Seite in Zuschauer-Modus
    socket.on('youAreOut', () => {
      alert('Du bist ausgeschieden. Du bleibst Zuschauer, bis die Lobby wieder öffnet.');
      joinCard.style.display = 'block';
      gameCard.style.display = 'none';
      // Join blockiert vom Backend solange Spiel läuft (stats-Event steuert Button)
    });

    // Registrierung Status (UI-Hinweis)
    socket.on('registrationClosed', () => setStatus('Spiel läuft – keine Anmeldung möglich','warn'));
    socket.on('registrationOpened', () => setStatus('Lobby – Anmeldung möglich','ok'));
  </script>
</body>
</html>
