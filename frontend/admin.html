<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>1 gegen 100 â€“ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Admin</h1>

    <div class="card">
      <div class="row">
        <span class="badge">Im Spiel: <span id="aliveCount">0</span>/<span id="totalCount">0</span></span>
        <span class="badge">Phase: <span id="phaseText">lobby</span></span>
        <span class="badge">Solo: <span id="soloNum">â€“</span></span>
        <span class="badge">Konto: <span id="bank">0</span> (Î” <span id="gain">0</span>)</span>
        <span class="badge">Joker: <span id="jokerInfo">bereit</span></span>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="soloInput" class="input" style="width:140px" placeholder="Solo-Nummer">
        <button id="setSoloBtn" class="btn secondary">Solo setzen</button>
        <button id="startBtn" class="btn">Spiel starten (Themenwahl)</button>
        <button id="openBtn"  class="btn secondary">Registrierung Ã¶ffnen</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Runde</h2>
      <div class="row">
        <button id="offerBtn" class="btn secondary">Themen anbieten</button>
        <button id="confirmTopicBtn" class="btn">Thema bestÃ¤tigen & Frage starten</button>
      </div>
      <div id="topicsInfo" class="footer">â€“</div>

      <div class="hr"></div>
      <h2>Joker</h2>
      <div class="row">
        <button id="buyAnswerBtn" class="btn secondary">Antwort kaufen (Bank halbiert)</button>
        <button id="doubleJokerBtn" class="btn secondary">Doppel-Joker fÃ¼r diese Frage</button>
      </div>
      <div id="jokerHint" class="footer">Noch nicht genutzt.</div>

      <div class="hr"></div>

      <h2>Frage</h2>
      <div id="qText" class="footer">â€“</div>
      <div id="soloTimer" class="footer">Solo-Lock-In: â€“</div>
      <div class="row">
        <button id="soloA1" class="btn secondary" disabled>Solo-Antwort A</button>
        <button id="soloA2" class="btn secondary" disabled>Solo-Antwort B</button>
        <button id="soloA3" class="btn secondary" disabled>Solo-Antwort C</button>

        <button id="revealBtn" class="btn">AuflÃ¶sen & Show</button>
        <button id="showCorrectBtn" class="btn secondary">Richtige Antwort zeigen</button>
        <button id="backBtn" class="btn secondary">ZurÃ¼ck zur Frageansicht</button>
        <button id="nextRoundBtn" class="btn secondary">NÃ¤chste Themenrunde</button>
      </div>
      <div id="players" class="player-list" style="margin-top:8px;"></div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script src="socket-config.js"></script>
  <script>
    const socket = createSocket();

    const setPhase = p => document.getElementById('phaseText').innerText = p;

    document.getElementById('setSoloBtn').onclick = ()=>{
      const n = Number(document.getElementById('soloInput').value);
      if(!n) return alert('Nummer eingeben');
      socket.emit('setSoloPlayer', n);
    };
    document.getElementById('startBtn').onclick = ()=> socket.emit('startGame');
    document.getElementById('openBtn').onclick  = ()=> socket.emit('openRegistration');

    document.getElementById('offerBtn').onclick = ()=> socket.emit('offerTopics');
    document.getElementById('confirmTopicBtn').onclick = ()=> socket.emit('startQuestionWithTopic');

    document.getElementById('buyAnswerBtn').onclick = ()=> socket.emit('useBuyAnswer');
    document.getElementById('doubleJokerBtn').onclick = ()=> socket.emit('activateDoubleJoker');

    document.getElementById('revealBtn').onclick = ()=> socket.emit('revealAndEliminate');
    document.getElementById('showCorrectBtn').onclick = ()=> socket.emit('revealCorrect');
    document.getElementById('backBtn').onclick   = ()=> socket.emit('backToQuestionView');
    document.getElementById('nextRoundBtn').onclick = ()=> socket.emit('nextRound');

    // Solo-Antwort-Buttons
    const soloButtons = [
      document.getElementById('soloA1'),
      document.getElementById('soloA2'),
      document.getElementById('soloA3')
    ];
    soloButtons.forEach((b,idx)=>{
      b.onclick = ()=>{
        const text = document.getElementById('qText').dataset.answers;
        if(!text){ alert('Keine Frage aktiv'); return; }
        const answers = JSON.parse(text);
        // Optik: aktive markieren
        soloButtons.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        socket.emit('setSoloAnswer', { index: idx, answer: answers[idx] });
      };
    });

    // Stats / Status
    socket.on('stats', ({alive,total,gamePhase,soloNumber,chosenTopic})=>{
      document.getElementById('aliveCount').innerText=alive;
      document.getElementById('totalCount').innerText=total;
      setPhase(gamePhase);
      document.getElementById('soloNum').innerText = soloNumber ?? 'â€“';
      const ti = document.getElementById('topicsInfo');
      if (chosenTopic) ti.textContent = 'GewÃ¤hltes Thema: '+chosenTopic;
    });
    socket.on('bankUpdate', ({prizePool,lastGain})=>{
      document.getElementById('bank').innerText = prizePool;
      document.getElementById('gain').innerText = lastGain;
    });
    socket.on('jokerUpdate', ({buyUsed,doubleUsed,doubleActive})=>{
      const info = [];
      if (doubleActive) info.push('Doppel-Joker aktiv');
      if (doubleUsed && !doubleActive) info.push('Doppel-Joker verbraucht');
      if (buyUsed) info.push('Antwort kaufen genutzt');
      document.getElementById('jokerInfo').innerText = info.join(' Â· ') || 'bereit';
      document.getElementById('doubleJokerBtn').disabled = doubleUsed;
      document.getElementById('buyAnswerBtn').disabled = buyUsed;
      document.getElementById('jokerHint').textContent = info.join(' Â· ') || 'Noch nicht genutzt.';
    });
    socket.on('soloSet', ({soloNumber})=>{
      document.getElementById('soloNum').innerText = soloNumber ?? 'â€“';
    });
    socket.on('topicOffered', ({options})=>{
      document.getElementById('topicsInfo').textContent = 'Angebotene Themen: '+options.join(' vs ');
    });
    socket.on('topicChosen', ({chosenTopic})=>{
      document.getElementById('topicsInfo').textContent = 'GewÃ¤hlt: '+chosenTopic;
    });
    socket.on('displayQuestion', (q)=>{
      const qt = document.getElementById('qText');
      qt.textContent = `(${q.topic}) ${q.text} [${q.answers.join(' / ')}]`;
      qt.dataset.answers = JSON.stringify(q.answers);
      // Buttons fÃ¼llen & aktivieren
      soloButtons.forEach((b,idx)=>{
        b.textContent = `Solo-Antwort ${String.fromCharCode(65+idx)}: ${q.answers[idx]}`;
        b.disabled = false;
        b.classList.remove('active');
      });
      document.getElementById('soloTimer').textContent = 'Solo-Lock-In: lÃ¤uftâ€¦';
    });

    let soloTimerTicker = null;
    socket.on('soloTimerStart', ({seconds})=>{
      if (soloTimerTicker) clearInterval(soloTimerTicker);
      const target = Date.now() + seconds*1000;
      soloTimerTicker = setInterval(()=>{
        const left = Math.max(0, Math.ceil((target - Date.now())/1000));
        document.getElementById('soloTimer').textContent = `Solo-Lock-In: ${left}s`;
        if (left<=0) { clearInterval(soloTimerTicker); soloTimerTicker=null; }
      }, 250);
    });
    socket.on('soloTimerEnd', ()=>{
      if (soloTimerTicker) clearInterval(soloTimerTicker);
      soloTimerTicker=null;
      document.getElementById('soloTimer').textContent = 'Solo-Lock-In: beendet';
    });

    socket.on('updatePlayers', (players)=>{
      document.getElementById('players').innerHTML = players
        .map(p => `${p.alive ? 'ðŸŸ¢' : 'ðŸ”´'} #${p.number}${p.lastAnswer ? ' Â· '+p.lastAnswer : ''}`)
        .join('<br>');
    });

    socket.on('adminError', msg => alert(msg));
    socket.on('noQuestionsLeftForTopic', ({topic})=> alert('Keine Fragen mehr fÃ¼r: '+topic));
  </script>
</body>
</html>
